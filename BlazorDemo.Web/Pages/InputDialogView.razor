@using System.IO
@implements IInputDialogService

<InputFile OnChange="@LoadFiles" 
           multiple="false"
           webkitdirectory="false"
           accept=".*" 
           style="position:absolute;top:-100px" 
           @ref=_inputFile />

@code {
    [Inject] private IJSRuntime? _js { get; set; }

    private InputDialogOptions? _options;

    private InputFile? _inputFile;

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        if (_options == null)
        {
            return;
        }
        Console.WriteLine("LoadFiles()");

        foreach (var file in e.GetMultipleFiles(_options.MaximumFileCount))
        {
            var stream = new MemoryStream();
            await file.OpenReadStream(_options.MaxAllowedSize).CopyToAsync(stream);
            stream.Position = 0;
            _options.Callback?.Invoke(stream, file.Name);
        }

        _options = null;
    }

    public async Task ShowInputDialog(InputDialogOptions options)
    {

        if (_js is { } && _inputFile?.Element is { })
        {
            Console.WriteLine("ShowInputDialog() Begin");

            _options = options;

            //*
            await _js.InvokeVoidAsync(
                "ShowInputDialog", 
                _inputFile?.Element, 
                _options.Filter, 
                _options.AllowMultiple, 
                _options.OpenFolder);
            //*/

            /*
            var fileHandle = await _js.InvokeAsync<IJSObjectReference>("ShowOpenFilePicker");
            Console.WriteLine($"fileHandle={fileHandle}");

            var file = await fileHandle.InvokeAsync<IJSObjectReference>("getFile");
            Console.WriteLine($"file={file}");

            var name = await _js.InvokeAsync<string>("GetPropertyValue", file, "name");
            Console.WriteLine($"name={name}");

            var stream = await file.InvokeAsync<IJSObjectReference>("stream");
            Console.WriteLine($"stream={stream}");

            var arrayBuffer = await file.InvokeAsync<IJSObjectReference>("arrayBuffer");
            Console.WriteLine($"arrayBuffer={arrayBuffer}");

            var text = await file.InvokeAsync<string>("text");
            Console.WriteLine($"text=\n{text}");
            //*/


            Console.WriteLine("ShowInputDialog() End");
        }
    }
}
