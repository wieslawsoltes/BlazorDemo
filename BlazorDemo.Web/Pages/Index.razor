@page "/"
@using System.IO

<InputFile OnChange="@LoadFiles" 
           id="file"
           multiple="@_multiple"
           webkitdirectory="@_openFolder"
           accept="@_filter" 
           style="position:absolute;top:-100px" 
           @ref=_inputFile />

<AvaloniaView />

@code {
    [Inject] private IJSRuntime? _js { get; set; }

    private Action<Stream, string>? _callback;

    private InputFile? _inputFile;

    private string _filter { get; set; } = ".*";

    private bool _multiple { get; set; } = false;

    private bool _openFolder { get; set; } = false;

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        Console.WriteLine("LoadFiles()");

        foreach (var file in e.GetMultipleFiles())
        {
            var stream = new MemoryStream();
            await file.OpenReadStream().CopyToAsync(stream);
            stream.Position = 0;
            _callback?.Invoke(stream, file.Name);
        }

        /*
        var stream = new MemoryStream();
        var file = e.File;
        await e.File.OpenReadStream().CopyToAsync(stream);
        stream.Position = 0;
        _callback?.Invoke(stream,  file.Name);
        */

        _callback = null;
    }

    private async Task ShowInputDialog(InputDialogOptions options)
    {
        if (_js is { } && _inputFile is { })
        {
            Console.WriteLine("ShowInputDialog() Begin");
            _callback = options.Callback;

            _filter = options.Filter;
            _multiple = options.AllowMultiple;
            _openFolder = options.OpenFolder;

            await _js.InvokeVoidAsync("ShowInputDialog", "file", _filter, _multiple, _openFolder);

            //var stream = await _js.InvokeAsync<FileStream>("ShowOpenFilePicker");
            //_callback(stream, "test");

            Console.WriteLine("ShowInputDialog() End");
        }
    }

    protected override void OnInitialized()
    {
        BlazorDemo.App.ShowInputDialog = this.ShowInputDialog;

        base.OnInitialized();
    }
}
